(function(t,i,o,r,e,s){function a(t){var i,o=t.length,e=this,s=0,a=e.i=e.j=0,h=e.S=[];for(o||(t=[o++]);r>s;)h[s]=s++;for(s=0;r>s;s++)h[s]=h[a=u&a+t[s%o]+(i=h[s])],h[a]=i;(e.g=function(t){for(var i,o=0,s=e.i,a=e.j,h=e.S;t--;)i=h[s=u&s+1],o=o*r+h[u&(h[s]=h[a=u&a+i])+(h[a]=i)];return e.i=s,e.j=a,o})(r)}function h(t,i){var o,r=[],e=(typeof t)[0];if(i&&"o"==e)for(o in t)try{r.push(h(t[o],i-1))}catch(t){}return r.length?r:"s"==e?t:t+"\0"}function n(t,i){for(var o,r=t+"",e=0;r.length>e;)i[u&e]=u&(o^=19*i[u&e])+r.charCodeAt(e++);return p(i)}function l(o){try{return t.crypto.getRandomValues(o=new Uint8Array(r)),p(o)}catch(o){return[+new Date,t,t.navigator.plugins,t.screen,p(i)]}}function p(t){return String.fromCharCode.apply(0,t)}var f=o.pow(r,6),d=o.pow(2,52),c=2*d,u=255;o.seedrandom=function(t,e){var s=[],u=n(h(e?[t,p(i)]:0 in arguments?t:l(),3),s),m=new a(s);return n(p(m.S),i),o.random=function(){for(var t=m.g(6),i=f,o=0;d>t;)t=(t+o)*r,i*=r,o=m.g(1);for(;t>=c;)t/=2,i/=2,o>>>=1;return(t+o)/i},u},n(o.random(),i)})(this,[],Math,256);{function choose(t){return 0==t.length?0:t[Math.floor(Math.random()*t.length)]}}var DungeonGen=function(){var t=-100,i=100,o=110,r=200,e=300,s=500,a=510,h=250,n=260,l=[];l[0]="000",l[-100]="900",l[100]="ffc",l[110]="ff9",l[200]="f9f",l[300]="990",l[400]="99f",l[500]="960",l[510]="630",l[250]="f9f",l[260]="f9f";var p=function(t,i){return Math.floor(Math.random()*(i-t+1)+t)},f=[];this.Pattern=function(t,i){this.name=t,this.func=i,f.push(this)},new this.Pattern("Pillars",(function(t,i,o){return(t+o.x)%2==0&&(i+o.y)%2==0&&Math.random()<.8?e:0})),new this.Pattern("Large pillars",(function(t,i,o){return(t+o.x)%3<2&&(i+o.y)%3<2&&Math.random()<.8?e:0})),new this.Pattern("Sparse pillars",(function(t,i,o){return(t+o.x)%3==0&&(i+o.y)%3==0&&Math.random()<.8?e:0})),new this.Pattern("Lines",(function(t,i,o){return o.x%2==0&&(t+o.x)%2==0&&Math.random()<.98||o.x%2==1&&(i+o.y)%2==0&&Math.random()<.98?e:0}));this.Map=function(i,o,r,e){null!=r?this.seed=r:(Math.seedrandom(),this.seed=Math.random()),Math.seedrandom(this.seed),this.seedState=Math.random,this.w=i||20,this.h=o||20,this.roomsAreHidden=0,this.rooms=[],this.freeWalls=[],this.freeTiles=[],this.doors=[],this.tiles=this.w*this.h,this.tilesDug=0,this.digs=0,this.stuck=0,this.data=[];for(var s=0;s<this.w;s++){this.data[s]=[];for(var a=0;a<this.h;a++)this.data[s][a]=[0,-1,0],0!=s&&0!=a&&s!=this.w-1&&a!=this.h-1||(this.data[s][a]=[t,-1,0])}var h;if((h=this).roomSize=10,h.corridorSize=5,h.fillRatio=1/3,h.corridorRatio=.2,h.pillarRatio=.2,h.waterRatio=0,h.branching=4,h.sizeVariance=.2,h.fillRatio=.1+.4*Math.random(),h.roomSize=Math.ceil(p(5,15)*h.fillRatio*2),h.corridorSize=Math.ceil(p(1,7)*h.fillRatio*2),h.corridorRatio=.8*Math.random()+.1,h.pillarRatio=.5*Math.random()+.5,h.waterRatio=Math.pow(Math.random(),2),h.branching=Math.floor(6*Math.random()),h.sizeVariance=Math.random(),e)for(var n in e)this[n]=e[n];Math.seedrandom()},this.Map.prototype.getType=function(t,i){return this.data[t][i][0]},this.Map.prototype.getRoom=function(t,i){return-1!=this.data[t][i][1]?this.rooms[this.data[t][i][1]]:-1},this.Map.prototype.getTile=function(t,i){return this.rooms[this.data[t][i][2]]},this.Map.prototype.isWall=function(t,i){var o=0;for(var r in this.freeWalls){if(this.freeWalls[r][0]==t&&this.freeWalls[r][1]==i)return o;o++}return-1},this.Map.prototype.isFloor=function(t,i){var o=0;for(var r in this.freeTiles){if(this.freeTiles[r][0]==t&&this.freeTiles[r][1]==i)return o;o++}return-1},this.Map.prototype.removeFreeTile=function(t,i){this.freeTiles.splice(this.isFloor(t,i),1)},this.Map.prototype.fill=function(t){var i=0;"function"==typeof t&&(i=1);for(var o=0;o<this.w;o++)for(var r=0;r<this.h;r++)this.data[o][r]=i?[t(this,o,r),-1,0]:[t,-1,0];this.rooms=[]},this.Map.prototype.fillZone=function(t,i,o,r,e){for(var s=t;s<t+o;s++)for(var a=i;a<i+r;a++)this.data[s][a][0]=e},this.Map.prototype.getRoomTile=function(t,i,o){var r=0;for(var e in t.tiles){if(t.tiles[e].x==i&&t.tiles[e].y==o)return r;r++}return-1},this.Map.prototype.getFloorTileInRoom=function(t){var r=[];for(var e in t.tiles)t.tiles[e].type!=i&&t.tiles[e].type!=o||r.push(t.tiles[e]);return choose(r)},this.Map.prototype.canPlaceRoom=function(i,o,r,e){if(i<2||o<2||i+r>=this.w-1||o+e>=this.h-1)return!1;for(var s=i;s<i+r;s++)for(var a=o;a<o+e;a++){var h=this.getType(s,a),n=this.getRoom(s,a);if(h==t)return!1;if(-1!=n)return!1}return!0},this.Map.prototype.setRoomTile=function(t,r,e,h){var n=this.getRoomTile(t,r,e),l=-1!=n?t.tiles[n].type:-1;return(-1==n||h!=s&&h!=a&&(h!=i||l!=o))&&(-1!=n&&t.tiles.splice(n,1),t.tiles.push({x:r,y:e,type:h,score:0}),h!=i&&h!=o||l==i||l==o?h==i||h==o||l!=i&&l!=o||t.freeTiles--:t.freeTiles++,!0)},this.Map.prototype.expandRoom=function(t,r,e,h,n){var l=0,p=0;for(l=r;l<r+h;l++)for(p=e;p<e+n;p++)this.setRoomTile(t,l,p,i);for(l=r+1;l<r+h-1;l++)for(p=e+1;p<e+n-1;p++)this.setRoomTile(t,l,p,o);p=e-1;for(l=r;l<r+h;l++)this.setRoomTile(t,l,p,s);p=e+n;for(l=r;l<r+h;l++)this.setRoomTile(t,l,p,s);l=r-1;for(p=e;p<e+n;p++)this.setRoomTile(t,l,p,s);l=r+h;for(p=e;p<e+n;p++)this.setRoomTile(t,l,p,s);l=r-1,p=e-1,this.setRoomTile(t,l,p,a),l=r+h,p=e-1,this.setRoomTile(t,l,p,a),l=r-1,p=e+n,this.setRoomTile(t,l,p,a),l=r+h,p=e+n,this.setRoomTile(t,l,p,a);var d=Math.random()<this.waterRatio?1:0,c=Math.random()<this.pillarRatio?choose(f):0;for(l=r;l<r+h;l++)for(p=e;p<e+n;p++)if(t.tiles[this.getRoomTile(t,l,p)].type==o){var u=0;0!=d&&(u=400),0!=c&&(u=c.func(l,p,t)||u),0!=u&&this.setRoomTile(t,l,p,u)}},this.Map.prototype.newRoom=function(t,i,o,r,e){var s={};return s.id=this.rooms.length,s.w=o,s.h=r,s.x=t||p(1,this.w-s.w-1),s.y=i||p(1,this.h-s.h-1),s.tiles=[],s.freeTiles=0,s.parent=e||-1,s.children=[],s.gen=0,s.door=0,s.corridor=Math.random()<this.corridorRatio?1:0,s.hidden=this.roomsAreHidden,s},this.Map.prototype.planRoom=function(t){for(var i=this.branching+1,o=[],r=t.w,e=t.h;r>0&&e>0;)r>0&&(o.push(1,3),r--),e>0&&(o.push(2,4),e--);for(var s=0;s<i;s++){var a=0,h=[];if(t.corridor?(h=choose([[1,3],[2,4]]),a=this.corridorSize):(h=[1,2,3,4],a=this.roomSize),a=Math.max(t.w+t.h,Math.ceil(a*(1-Math.random()*this.sizeVariance))),0==t.tiles.length)var n=t.x,l=t.y,p=1,f=1;else{var d=this.getFloorTileInRoom(t);n=d.x,l=d.y,p=1,f=1}for(var c=0;c<a&&0!=h.length;c++){var u=0,m=0,v=0,g=0,y=choose(h);o.length>0&&(y=o[0]),1==y?(u=-1,v=1):2==y?(m=-1,g=1):3==y?v=1:4==y&&(g=1),this.canPlaceRoom(n+u,l+m,p+v,f+g)?(n+=u,l+=m,p+=v,f+=g):h.splice(h.indexOf(y),1),o.length>0&&o.splice(0,1)}(p>1||f>1)&&this.expandRoom(t,n,l,p,f)}},this.Map.prototype.carve=function(t){for(var r in t.tiles){var e=t.tiles[r],h=e.x,n=e.y,l=(this.data[h][n][0],e.type);l!=s&&l!=a||-1==this.isWall(h,n)||this.freeWalls.splice(this.isWall(h,n),1),(-1==this.data[h][n][1]||l!=s&&l!=a)&&(-1==this.data[h][n][1]&&this.tilesDug++,this.data[h][n]=[e.type,t.id,0],h>1&&n>1&&h<this.w-2&&n<this.h-2&&l==s&&this.freeWalls.push([h,n]),l!=i&&l!=o||this.freeTiles.push([h,n]))}this.rooms[t.id]=t},this.Map.prototype.newRandomRoom=function(t){var i=1;t=t||{};var o=choose(this.freeWalls);if(o){var e=this.getRoom(o[0],o[1]),s=[];0==this.getType(o[0]-1,o[1])&&s.push([-1,0]),0==this.getType(o[0]+1,o[1])&&s.push([1,0]),0==this.getType(o[0],o[1]-1)&&s.push([0,-1]),0==this.getType(o[0],o[1]+1)&&s.push([0,1]);var a=choose(s);if(a){var h=this.newRoom(o[0]+a[0],o[1]+a[1],0,0,e);for(var n in t)h[n]=t[n];this.planRoom(h),h.tiles.length>0&&h.freeTiles>0?(this.carve(h),this.data[o[0]][o[1]][0]=r,h.door=[o[0],o[1]],this.data[o[0]][o[1]][1]=h.id,this.freeWalls.splice(this.isWall(o[0],o[1]),1),this.doors.push([o[0],o[1],h]),-1!=this.isFloor(o[0]+a[0],o[1]+a[1])&&this.removeFreeTile(o[0]+a[0],o[1]+a[1]),-1!=this.isFloor(o[0]-a[0],o[1]-a[1])&&this.removeFreeTile(o[0]-a[0],o[1]-a[1]),h.parent=e,e.children.push(h),h.gen=e.gen+1):(this.freeWalls.splice(this.isWall(o[0],o[1]),1),i=0)}else i=0,this.freeWalls.splice(this.isWall(o[0],o[1]),1)}else i=0;return i?h:0},this.Map.prototype.getRandomSpotInRoom=function(t){var r=[];for(var e in t.tiles)t.tiles[e].type!=i&&t.tiles[e].type!=o||-1==this.isFloor(t.tiles[e].x,t.tiles[e].y)||r.push(t.tiles[e]);return 0==r.length?-1:choose(r)},this.Map.prototype.getBestSpotInRoom=function(t){var r=-1,e=[];for(var s in t.tiles)t.tiles[s].type!=i&&t.tiles[s].type!=o||-1==this.isFloor(t.tiles[s].x,t.tiles[s].y)||(t.tiles[s].score>r?(e=[],r=t.tiles[s].score,e.push(t.tiles[s])):t.tiles[s].score==r&&e.push(t.tiles[s]));return 0==e.length?-1:choose(e)},this.Map.prototype.getEarliestRoom=function(){return this.rooms[0]},this.Map.prototype.getDeepestRoom=function(){var t=0,i=this.rooms[0];for(var o in this.rooms)this.rooms[o].gen+.05*Math.sqrt(this.rooms[o].freeTiles)>=t&&0==this.rooms[o].corridor&&this.rooms[o].freeTiles>4&&(t=this.rooms[o].gen+.05*Math.sqrt(this.rooms[o].freeTiles),i=this.rooms[o]);return i},this.Map.prototype.dig=function(){Math.random=this.seedState;var t=0;if(0==this.digs){var i=p(3,7),o=p(3,7),r=this.newRoom(Math.floor(this.w/2-i/2),Math.floor(this.h/2-o/2),i,o);r.corridor=0,this.planRoom(r),this.carve(r)}else 0==this.newRandomRoom()&&t++;t>0&&this.stuck++,this.digs++;var e=0;if(this.tilesDug>=this.tiles*this.fillRatio&&(e=1),this.stuck>100&&(e=1),1==e)for(var s=0;s<10;s++){var a=this.newRandomRoom({corridor:0,w:p(3,7),h:p(3,7)});if(0!=a&&a.freeTiles>15)break}return Math.seedrandom(),1==e?1:t>0?-1:0},this.Map.prototype.finish=function(){for(var t in this.rooms){var l=Math.random()<this.pillarRatio;for(var p in this.rooms[t].tiles){var f=this.rooms[t].tiles[p].x,d=this.rooms[t].tiles[p].y,c=this.data[f][d][0],u=this.data[f-1][d][0],m=this.data[f+1][d][0],v=this.data[f][d-1][0],g=this.data[f][d+1][0],y=this.data[f-1][d-1][0],M=this.data[f+1][d-1][0],x=this.data[f-1][d+1][0],R=this.data[f+1][d+1][0],T=0;u!=s&&u!=a||T++,v!=s&&v!=a||T++,m!=s&&m!=a||T++,g!=s&&g!=a||T++,y!=s&&y!=a||T++,M!=s&&M!=a||T++,x!=s&&x!=a||T++,R!=s&&R!=a||T++;var w=0;u!=o&&u!=i||w++,v!=o&&v!=i||w++,m!=o&&m!=i||w++,g!=o&&g!=i||w++,y!=o&&y!=i||w++,M!=o&&M!=i||w++,x!=o&&x!=i||w++,R!=o&&R!=i||w++;var b=0;T+w==8&&(b=1);var S=0;if(b){var W=0,F=0,k=0,z=0;y!=s&&y!=a||v!=s&&v!=a||M!=s&&M!=a?y!=o&&y!=i||v!=o&&v!=i||M!=o&&M!=i||(W=-1):W=1,M!=s&&M!=a||m!=s&&m!=a||R!=s&&R!=a?M!=o&&M!=i||m!=o&&m!=i||R!=o&&R!=i||(k=-1):k=1,y!=s&&y!=a||u!=s&&u!=a||x!=s&&x!=a?y!=o&&y!=i||u!=o&&u!=i||x!=o&&x!=i||(F=-1):F=1,x!=s&&x!=a||g!=s&&g!=a||R!=s&&R!=a?x!=o&&x!=i||g!=o&&g!=i||R!=o&&R!=i||(z=-1):z=1,(1==W&&-1==z||-1==W&&1==z||1==F&&-1==k||-1==F&&1==k)&&(S=1)}l&&Math.random()<.8&&this.rooms[t].freeTiles>4&&(1==S||b&&7==T)&&c==i&&u!=r&&m!=r&&v!=r&&g!=r&&(this.data[f][d][0]=e,c=e,this.removeFreeTile(f,d),this.rooms[t].freeTiles--),1!=W&&1!=z&&1!=F&&1!=k||(this.rooms[t].tiles[p].score+=2),(T>5||w>5)&&(this.rooms[t].tiles[p].score+=1),7!=T&&8!=w||(this.rooms[t].tiles[p].score+=5),(c!=o&&c!=i||u==r||m==r||v==r||g==r)&&(this.rooms[t].tiles[p].score=-1)}}var P=this.getBestSpotInRoom(this.getEarliestRoom());this.data[P.x][P.y][0]=h,this.entrance=[P.x,P.y],P.score=0,this.removeFreeTile(P.x,P.y);var D=this.getBestSpotInRoom(this.getDeepestRoom());this.data[D.x][D.y][0]=n,this.exit=[D.x,D.y],this.removeFreeTile(D.x,D.y),D.score=0},this.Map.prototype.isObstacle=function(t,e){var s=[i,o,r,h,n];for(var a in s)if(this.data[t][e][0]==s[a])return 0;return 1};this.Map.prototype.getPic=function(t,i){if(d[this.data[t][i][2]]){if("join"==d[this.data[t][i][2]].joinType){e=[(e=d[this.data[t][i][2]].pic)[0],e[1]];var o=[];return this.data[t][i][0]==s?o.push(a):this.data[t][i][0]==r&&o.push(s,a),e[0]+=function(t,i,o,r){var e=1,s=t.data[i][o][0],a=t.data[i-1][o][0],h=t.data[i+1][o][0],n=t.data[i][o-1][0],l=t.data[i][o+1][0];r.push(s);var p=0;for(var f in r)a==r[f]&&p++,h==r[f]&&p++;var d=0;for(var f in r)n==r[f]&&d++,l==r[f]&&d++;return 2==p&&2==d?e=1:2==p?e=2:2==d&&(e=3),e}(this,t,i,o)-1,e}var e;return"random3"==d[this.data[t][i][2]].joinType?((e=[(e=d[this.data[t][i][2]].pic)[0],e[1]])[0]+=Math.floor(3*Math.random()),e):d[this.data[t][i][2]].pic}return[0,0]};var d=[],c=[];this.Tile=function(t,i,o){this.name=t,this.pic=i,this.joinType=o||"none",this.id=d.length,d[this.id]=this,c[this.name]=this},new this.Tile("void",[0,0]),this.loadTiles=function(t){for(var i in t){var o=t[i][0],r=t[i][1],e=t[i][2];new this.Tile(o,r,e)}};var u=function(t,i,o,r){return t==o&&i[r]?c[i[r]]:0};this.Map.prototype.assignTiles=function(t,l){for(var p in t.tiles){var f=d[0],c=t.tiles[p],m=this.data[c.x][c.y][0];f=u(m,l,a,"wall corner")||f,f=u(m,l,s,"wall")||f,f=u(m,l,i,"floor edges")||f,f=u(m,l,o,"floor")||f,f=u(m,l,e,"pillar")||f,f=u(m,l,r,"door")||f,f=u(m,l,400,"water")||f,f=u(m,l,h,"entrance")||f,f=u(m,l,n,"exit")||f,this.data[c.x][c.y][2]=f.id}},this.Map.prototype.draw=function(t){for(var i="",o=(t=t||10,0);o<this.h;o++){for(var r=0;r<this.w;r++){var e="";-1!=this.isFloor(r,o)&&(e="o"),-1!=this.isWall(r,o)&&(e+="x");var s=this.getRoom(r,o),a=Math.max(.1,1-this.getRoom(r,o).gen/10),h=s.freeTiles;e="",i+='<div style="opacity:'+a+";width:"+t+"px;height:"+t+"px;position:absolute;left:"+r*t+"px;top:"+o*t+"px;display:block;padding:0px;margin:0px;background:#"+l[this.data[r][o][0]]+';color:#999;" title="'+h+'">'+e+"</div>"}i+="<br>"}return i='<div style="position:relative;width:'+this.w*t+"px;height:"+this.h*t+"px;background:#000;font-family:Courier;font-size:"+t+'px;float:left;margin:10px;">'+i+"</div>"},this.Map.prototype.drawDetailed=function(){for(var t="",i=16,o=0;o<this.h;o++){for(var r=0;r<this.w;r++){var e=this.getRoom(r,o),s=1,a="void";-1!=e&&(s=Math.max(.1,1-e.gen/5),this.data[r][o][0]!=h&&this.data[r][o][0]!=n||(s=1),a=(e.corridor?"corridor":"room")+" "+e.id+" | depth : "+e.gen+" | children : "+e.children.length);var p=this.getPic(r,o);t+='<div style="opacity:'+s+";width:"+"16px;height:"+"16px;position:absolute;left:"+r*i+"px;top:"+o*i+"px;display:block;padding:0px;margin:0px;background:#"+l[this.data[r][o][0]]+" url(img/dungeonTiles.png) "+16*-p[0]+"px "+16*-p[1]+'px;color:#999;" title="'+a+'"></div>'}t+="<br>"}return t='<div style="box-shadow:0px 0px 12px 6px #00061b;position:relative;width:'+this.w*i+"px;height:"+this.h*i+"px;background:#00061b;font-family:Courier;font-size:"+'16px;float:left;margin:10px;">'+t+"</div>"},this.Map.prototype.getStr=function(){for(var t="",i=0;i<this.h;i++){for(var o=0;o<this.w;o++){var r=this.getRoom(o,i),e="void",s=this.getPic(o,i);-1!=r&&(r.hidden&&(s=[0,0]),e=(r.corridor?"corridor":"room")+" "+r.id+" | depth : "+r.gen+" | children : "+r.children.length),t+='<div style="opacity:1;width:16px;height:16px;position:absolute;left:'+16*o+"px;top:"+16*i+"px;display:block;padding:0px;margin:0px;background:#"+l[this.data[o][i][0]]+" url(img/dungeonTiles.png) "+16*-s[0]+"px "+16*-s[1]+'px;color:#999;" title="'+e+'"></div>'}t+="<br>"}return t}};
